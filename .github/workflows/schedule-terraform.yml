name: Schedule Terraform Apply

on:
  # PRãŒä½œæˆãƒ»æ›´æ–°ã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œ
  pull_request:
    types: [opened, edited, labeled]
  # å®šæœŸçš„ãªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ï¼ˆ5åˆ†æ¯ï¼‰
  schedule:
    - cron: '*/5 * * * *'

jobs:
  process-schedule:
    runs-on: ubuntu-latest
    steps:
      - name: Check scheduled applies
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const now = new Date();
            
            // terraform-scheduleãƒ©ãƒ™ãƒ«ãŒä»˜ã„ã¦ã„ã‚‹PRã‚’æ¤œç´¢
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.name,
              state: 'open',
              labels: 'terraform-schedule'
            });
            
            for (const pr of prs.data) {
              // PRæœ¬æ–‡ã‹ã‚‰ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æƒ…å ±ã‚’è§£æ
              const scheduleMatch = pr.body.match(/schedule:\s*(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2})/);
              if (!scheduleMatch) continue;
              
              const scheduleTime = new Date(scheduleMatch[1]);
              
              // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ™‚åˆ»ã‚’éãã¦ã„ã¦ã€ã¾ã å®Ÿè¡Œã•ã‚Œã¦ã„ãªã„å ´åˆ
              if (scheduleTime <= now && !pr.labels.some(label => label.name === 'terraform-executed')) {
                // Atlantis applyã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.name,
                  issue_number: pr.number,
                  body: 'atlantis apply'
                });
                
                // PRã«executedãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.name,
                  issue_number: pr.number,
                  labels: ['terraform-executed']
                });
                
                // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.name,
                  issue_number: pr.number,
                  name: 'terraform-schedule'
                });
                
                // å®Ÿè¡Œãƒ­ã‚°ã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.name,
                  issue_number: pr.number,
                  body: `ğŸ•’ Scheduled terraform apply executed at ${new Date().toISOString()}`
                });
              }
            }
